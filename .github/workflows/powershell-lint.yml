name: PowerShell Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install PSScriptAnalyzer
        shell: pwsh
        run: |
          Remove-Module PSScriptAnalyzer -ErrorAction SilentlyContinue
          Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -SkipPublisherCheck -AllowClobber
          Import-Module PSScriptAnalyzer -Force

      - name: Run PSScriptAnalyzer on scripts
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          $files = Get-ChildItem -Path ./scripts -Filter '*.ps1' -File -Recurse | Select-Object -ExpandProperty FullName
          if (-not $files) {
            Write-Host "No PowerShell scripts found under ./scripts."
            exit 0
          }
          Invoke-ScriptAnalyzer -Path $files -Recurse -Severity Error,Warning

  test:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Pester
        shell: pwsh
        run: |
          Install-Module Pester -Scope CurrentUser -Force -SkipPublisherCheck -Confirm:$false

      - name: Run Pester tests
        shell: pwsh
        run: |
          $ErrorActionPreference = 'Stop'
          Invoke-Pester -CI -Path tests
